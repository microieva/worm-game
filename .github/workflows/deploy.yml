name: Deploy to DataCrunch

on:
  push:
    branches: [ master ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    - uses: webfactory/ssh-agent@v0.8.0
      with:
        ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}
    - run: ssh-keyscan -H ${{ secrets.SERVER_HOST }} >> ~/.ssh/known_hosts
    - name: Deploy to server
      run: |
        ssh -o StrictHostKeyChecking=no ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }} << 'EOF'
          set -e  # Exit on any error
          cd /root/worm-game
          
          echo "🚀 Starting deployment process..."

          # Stop existing containers
          echo "🛑 Stopping existing containers..."
          docker compose down || echo "⚠️  No containers to stop (first deployment?)"
          docker container prune -f
          docker system prune -f
          
          # Pull latest code
          echo "📥 Pulling latest code..."
          git pull origin master

          echo "🧹 Cleaning previous builds..."
          ./mvnw clean
          rm -rf target/
          
          # Run start script
          echo "🔧 Running setup script..."
          chmod +x deploy.sh
          ./deploy.sh
          
          # Verify deployment
          echo "🔍 Verifying deployment..."
          sleep 10  # Wait for containers to start
          docker compose ps
          
          echo "🎉 Deployment completed successfully!"
        EOF